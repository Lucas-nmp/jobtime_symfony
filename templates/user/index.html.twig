{% extends 'base.html.twig' %}

{% block title %}Ver fichajes{% endblock %}

{% block body %}
<h2 class="card-title mb-4 text-center">Ver fichajes</h2>
<div class="d-flex justify-content-center align-items-center" style="min-height: 30vh;">
    <div class="card p-4" style="max-width: 600px; width: 100%;">
        <div class="mb-3">
            {% if role == 'ROLE_ADMIN' %}
                <label for="userSelect" class="form-label">Seleccione un Usuario</label>
                <select id="userSelect" class="form-select" onchange="loadUserData(this.value)">
                    <option value="">-- Seleccione un Usuario --</option>
                    {% for user in users %}
                        <option value="{{ user.id }}">{{ user.id }} - {{ user.name }}</option>
                    {% endfor %}
                </select>
            {% else %}
                <label for="userSelect" class="form-label">Usuario</label>
                <select id="userSelect" class="form-select" onchange="loadUserData(this.value)">
                    <option value="">{{ user.id }} - {{ user.name }}</option>
                </select>
            {% endif %}
        </div>

        <!-- Selectores de Fecha -->
        <div class="row mb-3">
            <div class="col">
                <label for="yearSelect" class="form-label">Año</label>
                <select id="yearSelect" class="form-select">
                    <option value="">Seleccione año</option>
                </select>
            </div>
            <div class="col">
                <label for="monthSelect" class="form-label">Mes</label>
                <select id="monthSelect" class="form-select" onchange="updateDays()">
                    <option value="">Seleccione mes</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
            </div>
            <div class="col">
                <label for="daySelect" class="form-label">Día</label>
                <select id="daySelect" class="form-select">
                    <option value="">Seleccione día</option>
                </select>
            </div>
        </div>
        
        <div class="mb-3 text-center">
            <button class="btn btn-primary w-100" onclick="showSignings()">Ver fichajes</button>
        </div>

        <div class="mb-3">
            <h5>Fichajes:</h5>
            <ul id="signingsList">
                {% for signing in signings %}
                    <li>
                        Fecha: {{ signing.datetime|date("d-m-Y") }} - Hora: {{ signing.datetime|date("H:i:s") }}
                    </li>
                {% endfor %}
            </ul>

            <div class="mt-3">
                <h5>Total de horas trabajadas el {{ formattedDate }}: {{ totalHours }}</h5>
            </div>
        </div>
        <!-- Botón para generar el PDF -->
        <form action="{{ path('app_user_print_pdf') }}" method="get">
            <input type="hidden" name="totalHours" value="{{ totalHours }}">
            
            {# Solo formatear la fecha si es una fecha completa (año, mes y día) #}
            <input type="hidden" name="formattedDate" 
                value="{% if selectedDate matches '/^\d{2}-\d{2}-\d{4}$/' %}
                            {{ selectedDate|date('d-m-Y') }}
                        {% else %}
                            {{ selectedDate }}
                        {% endif %}">
            <div class="mb-3 text-center">
                <button type="submit" class="btn btn-primary w-100">Imprimir PDF</button>
            </div>            
            
        </form>



    </div>
</div>

<script>

    function showSignings() {
        const userId = document.getElementById('userSelect').value;
        const year = document.getElementById('yearSelect').value;
        const month = document.getElementById('monthSelect').value;
        const day = document.getElementById('daySelect').value;
        
        window.location.href = `/user?userId=${userId}&year=${year}&month=${month}&day=${day}`;
    }

    // Generar los años desde el año actual hasta 4 años atrás
    const currentYear = new Date().getFullYear();
    const yearSelect = document.getElementById('yearSelect');
    for (let i = 0; i < 5; i++) {
        const option = document.createElement('option');
        option.value = currentYear - i;
        option.textContent = currentYear - i;
        yearSelect.appendChild(option);
    }

    // Función para actualizar los días en función del mes seleccionado
    function updateDays() {
        const monthSelect = document.getElementById('monthSelect');
        const daySelect = document.getElementById('daySelect');
        const selectedMonth = monthSelect.value;
        
        // Vaciar opciones de día
        daySelect.innerHTML = '<option value="">Seleccione día</option>';
        
        // Definir la cantidad de días en función del mes seleccionado
        let daysInMonth;
        if (selectedMonth === '2') { // Febrero
            const selectedYear = parseInt(yearSelect.value);
            daysInMonth = (selectedYear % 4 === 0 && selectedYear % 100 !== 0) || selectedYear % 400 === 0 ? 29 : 28;
        } else if (['4', '6', '9', '11'].includes(selectedMonth)) { // Abril, Junio, Septiembre, Noviembre
            daysInMonth = 30;
        } else {
            daysInMonth = 31;
        }

        // Añadir los días al selector
        for (let i = 1; i <= daysInMonth; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            daySelect.appendChild(option);
        }
    }
</script>
{% endblock %}


